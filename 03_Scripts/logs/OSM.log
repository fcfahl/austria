15:42:24 WARNING  is when this event was logged.
15:42:24 INFO     DROP TABLE IF EXISTS plants_resources_grouped;
CREATE TABLE plants_resources_grouped AS

        WITH
            selection AS (
                SELECT a.id_target, a.length, a.lsu, a.manure, a.methane, a.crop, a.total_area, a.geom
                     FROM plants_resources AS a
                     LEFT JOIN topo_targets AS b
                     ON a.id_target = b.id_target
                     ORDER BY a.id_target, a.length
                ),
            manure AS (
                SELECT b.id_target, sum(b.lsu) AS lsu, sum(b.manure) AS manure, sum(b.methane) AS methane, sum(b.length) AS manure_distance
                FROM (SELECT * FROM  selection WHERE length < 10000) AS b
                GROUP BY b.id_target
               ),
            crop AS (
                SELECT b.id_target, sum(b.crop) AS crop, sum(b.total_area) as total_area, sum(b.length) AS crop_distance
                FROM selection AS b
                GROUP BY b.id_target
               ),
            join_tables AS (
                SELECT m.id_target, m.lsu, m.manure, m.methane, c.crop, c.total_area, m.manure_distance, c.crop_distance
                FROM manure AS m
                LEFT JOIN crop AS c
                ON m.id_target = c.id_target
               )
        SELECT
            a.*, s.geom
        FROM
            join_tables AS a
        LEFT JOIN (SELECT DISTINCT ON (id_target) * FROM selection) AS s
        ON a.id_target = s.id_target
    ;
15:42:26 INFO     ALTER TABLE plants_resources_grouped ADD COLUMN  id_plants SERIAL PRIMARY KEY;
